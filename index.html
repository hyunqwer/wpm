<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reading Fluency Analyzer (OpenAI STT)</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; line-height: 1.6; }
    textarea { width: 100%; height: 100px; }
    .word.correct { color: green; font-weight: bold; }
    .word.incorrect { color: red; font-weight: bold; }
    .results { margin-top: 20px; }
  </style>
</head>
<body>
  <h1>Reading Fluency Analyzer (OpenAI STT)</h1>

  <label for="levelSelect">📚 윤선생 YES4.0 수준을 선택하세요:</label>
  <select id="levelSelect">
    <option value="RS3">Rising Star 3</option>
    <option value="RS4">Rising Star 4</option>
    <option value="AS5">All-Star 5</option>
    <option value="AS6">All-Star 6</option>
    <option value="MVP">MVP</option>
    <option value="MS12">중고등 Level 1~2</option>
    <option value="MS34">중고등 Level 3~4</option>
    <option value="MS56">중고등 Level 5~6</option>
    <option value="MS79">중고등 Level 7~9</option>
  </select><br><br>

  <label for="textInput">📝 읽을 텍스트:</label>
  <textarea id="textInput"></textarea>

  <div>
    <button id="startBtn">Start Reading</button>
    <button id="stopBtn" disabled>Stop Reading</button>
  </div>

  <div class="results">
    <h2>📣 음성 인식 결과:</h2>
    <div id="outputText"></div>
    <h3>📊 분석 결과</h3>
    <p>읽은 시간: <span id="duration"></span>초</p>
    <p>WPM: <span id="wpm"></span></p>
    <p>WCPM: <span id="wcpm"></span></p>
  </div>

  <script>
    /* ---------- 1. 기본 텍스트 세팅 ---------- */
    const texts = {
      RS3:`Where is the fox? The fox is on the box. Where is the snake? The snake is in the lake. Where am I? I am right here!`,
      RS4:`I am a member of a reading club in my school. We meet every Wednesday and Friday. We meet in the club room for an hour. We read a book a week.`,
      AS5:`Before there were cameras, people asked someone else to paint their portraits. This was the only way that you could have a picture of yourself. Old portraits are very realistic and look like photos.`,
      AS6:`Do you want to get into the drama club? You need to pass the audition first. Don't be nervous during the audition. You should be comfortable on the stage. Stand up straight. Then, your body and face will look better. Smile and speak loudly to show confidence. Do you need to sing during your audition? If so, warm up your voice and drink plenty of water beforehand.`,
      MVP:`Danny Johnson was eighty-six years old. Every day, he played chess with his friends. They always talked about their childhoods. Danny liked to tell his friends stories and drink tea. One day, Danny was having a conversation with his friend, Carl. "What do you remember about your mother?" Carl asked. Danny thought about her and smiled. She died from an illness many years ago.`,
      MS12:`Many kinds of music can affect our body in positive ways. Music can help reduce pain. It can also improve physical performance. Because music affects the whole brain, it can have surprising benefits for learning languages, improving memory, and focusing. Music affects our feelings, too. Listening to music can help us work more effectively. It can also help us sleep more easily and decrease stress.`,
      MS34:`Everyone needs goals. Having goals makes you more successful because they keep your mind on what is really important to you. However, your goals can change at different times in your life. Your goals when you were ten are very different from your goals when you are twenty. My major goals are to get a part-time job and to master the English language. In conclusion, it is important to have goals. When you have clear goals, it is easier to stay focused.`,
      MS56:`People love Broadway musicals because they combine music, song, and dance. These elements move the plot and highlight action. They also energize an audience. People sit in their seats and tap their feet to the music. Entire audiences hum along. People return to the same show time after time because they become involved in the enthusiasm of a live performance.`,
      MS79:`The earth is a dynamic planet, constantly changing. But the change occurs so slowly that, to humans, the earth seems stable. Geologists believe that the earth changes because of the movement of plates on the earth's surface. This theory, called plate tectonics, says the earth is covered by seven major plates and several minor plates. These plates move away from each other, crash into each other, and grind against each other. At the junctions of the plates, we find dramatic geologic activity such as earthquakes, volcanoes, and mountain building.`
    };

    const $ = id => document.getElementById(id);
    $("levelSelect").onchange = e => $("textInput").value = texts[e.target.value];
    $("textInput").value = texts["RS3"];

    /* ---------- 2. 녹음 관련 전역 ---------- */
    let mediaRecorder, audioChunks = [], startTime, endTime;
    const startBtn=$("startBtn"), stopBtn=$("stopBtn"),
          output=$("outputText"), wpm=$("wpm"), wcpm=$("wcpm"), duration=$("duration");

    /* ---------- 3. 지원 mimeType 탐색 ---------- */
    function getSupportedMimeType() {
      const preferred = [
        'audio/mp4',
        'audio/webm;codecs=opus',
        'audio/webm',
        'audio/mpeg'
      ];
      return preferred.find(t => MediaRecorder.isTypeSupported(t)) || '';
    }

    /* ---------- 4. 녹음 시작 ---------- */
    startBtn.onclick = async () => {
      try {
        const mimeType = getSupportedMimeType();
        if (!mimeType) throw new Error("이 브라우저는 MediaRecorder를 지원하지 않습니다.");

        const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
        mediaRecorder = new MediaRecorder(stream, { mimeType });
        audioChunks = [];
        mediaRecorder.ondataavailable = e => e.data.size && audioChunks.push(e.data);

        startTime = Date.now();
        output.innerHTML = "🎤 음성 녹음 중...";
        startBtn.disabled = true;
        stopBtn.disabled  = false;
        mediaRecorder.start();
      } catch(err) {
        alert("마이크 접근 실패: " + err.message);
      }
    };

    /* ---------- 5. 녹음 중지 ---------- */
    stopBtn.onclick = () => {
      stopBtn.disabled = true;
      endTime = Date.now();
      mediaRecorder.stop();

      mediaRecorder.onstop = async () => {
        const mimeType = mediaRecorder.mimeType;
        const ext = mimeType.includes('mp4') ? 'mp4'
                 : mimeType.includes('mpeg')? 'mp3'
                 : 'webm';

        const audioBlob = new Blob(audioChunks, { type: mimeType });
        if (audioBlob.size < 4096) {
          alert("녹음된 오디오가 너무 짧거나 비어 있습니다. 다시 시도해 주세요.");
          startBtn.disabled=false; return;
        }

        const formData = new FormData();
        formData.append("file", audioBlob, `audio.${ext}`);
        formData.append("model","whisper-1");

        output.innerHTML = "🧠 음성 인식 중(OpenAI)...";

        try {
          const res = await fetch("https://frosty-term-f13a.hyunqwer.workers.dev/",{
            method:"POST", body:formData });
          if (!res.ok) throw new Error("STT 서버 응답 오류: "+res.status);
          const json = await res.json();
          const transcript = json?.text?.trim();
          if (!transcript) throw new Error("STT 응답에 텍스트가 없습니다.");

          analyzeResults(transcript);
        } catch(err) {
          alert("STT 오류 발생: " + err.message);
        }
        startBtn.disabled=false;
      };
    };

    /* ---------- 6. 결과 분석 ---------- */
    function analyzeResults(transcript){
      const origin   = $("textInput").value.trim().split(/\s+/);
      const spoken   = transcript.split(/\s+/);
      const clean = w => w.toLowerCase().replace(/[.,!?—-]/g,"");
      const lowerO = origin.map(clean), lowerS = spoken.map(clean);

      const matched = new Set(), usedS=new Set();
      lowerO.forEach((w,i)=>{
        const j = lowerS.findIndex((s,idx)=>!usedS.has(idx)&&s===w);
        if (j>-1){ matched.add(i); usedS.add(j); }
      });

      output.innerHTML = origin.map((w,i)=>
        `<span class="word ${matched.has(i)?"correct":"incorrect"}">${w}</span>`).join(" ");

      const sec=(endTime-startTime)/1000;
      duration.textContent = sec.toFixed(1);
      wpm.textContent  = ((spoken.length   /sec)*60).toFixed(1);
      wcpm.textContent = ((matched.size/sec)*60).toFixed(1);
    }
  </script>
</body>
</html>
